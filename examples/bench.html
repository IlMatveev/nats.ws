<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Test</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
          crossorigin="anonymous">
</head>
<body>

<div class="container">
    <h1 id="title">WS NATS Browser Performance</h1>
    <label for="server">Server</label>
    <input type="text" class="form-control" id="server" placeholder="server" autocomplete="off"
           value="ws://localhost:8080"><br/>
    <label for="subject">Subject</label>
    <input type="text" class="form-control" id="subject" placeholder="subject" autocomplete="off" value="foo"><br/>
    <label for="messages">Number of Messages</label>
    <input type="number" class="form-control" id="messages" placeholder="messages" autocomplete="off"
           value="100000"><br/>
    <label for="flush">Flush after</label>
    <input type="number" class="form-control" id="flush" placeholder="flush" autocomplete="off" value="1000"><br/>

    <h3>Test</h3>
    <div class="radio-inline">
        <label><input class="form-check-input" type="radio" value="pubsub" checked id="pubsub"
                      name="test">Pub/Sub</label>
    </div>
    <div class="radio-inline">
        <label><input class="form-check-input" type="radio" value="pub" id="pub" name="test">Publish</label>
    </div>
    <div class="radio-inline">
        <label><input class="form-check-input" type="radio" value="sub" id="sub" name="test">Subscribe</label>
    </div>

    <br/><br/>
    <button id="send" onclick="run()" class="btn btn-primary">Start</button>
</div>
<br/>
<div class="container">
    <pre id="results"></pre>
</div>


<script src="../lib/nats.js"></script>

<script>
    function getString(id) {
        return document.getElementById(id).value;
    }

    function isChecked(id) {
        return document.getElementById(id).checked;
    }

    function getTestChoice() {
        if (isChecked("pubsub")) {
            return "pubsub";
        } else if (isChecked("pub")) {
            return "pub";
        } else if (isChecked("sub")) {
            return "sub";
        }
    }

    function getNumber(id) {
        let v = getString(id);
        if (!isNaN(v)) {
            return parseInt(v, 10);
        }
        return -1
    }

    function setResults(s) {
        document.getElementById('results').innerHTML = s;
    }

    async function run() {
        let test = getTestChoice();
        switch (test) {
            case "pub":
                pub();
                break;
            case "sub":
                sub();
                break;
            case "pubsub":
                pubsub();
                break;
        }
    }

    function getOpts() {
        return {
            server: getString('server'),
            subject: getString('subject'),
            max: getNumber('messages'),
            count: 0,
            flush: getNumber('flush'),
            start: 0,
            end: 0
        };
    }

    function results(test, opts) {
        let time = opts.end - opts.start;
        let count = Number(opts.count).toLocaleString();
        let times = Number(time).toLocaleString();

        let rate = Number(Number(opts.count / (time / 1000)).toFixed(0)).toLocaleString();

        setResults(`${test} ${count} messages in ${times} ms (${rate} msgs/sec)`);
    }

    async function pub() {
        let opts = getOpts();
        setResults('working...');
        let nc = await nats.connect({url: opts.server});
        opts.start = Date.now();
        for (let i = 0; i < opts.max; i++) {
            nc.publish(opts.subject);
            if (i % opts.flush === 0) {
                await nc.flush();
            }
        }
        await nc.flush();
        opts.count = opts.max;
        opts.end = Date.now();
        nc.close();
        results("pub", opts);
    }

    async function sub() {
        let opts = getOpts();
        setResults('waiting for messages...');
        let nc = await nats.connect({url: opts.server});
        await nc.subscribe(opts.subject, () => {
            if (opts.count === 0) {
                setResults('Working...');
                opts.start = Date.now();
            }
            opts.count++;
            if (opts.count >= opts.max) {
                opts.end = Date.now();
                nc.close();
                results('sub', opts);
            }
        }, {max: opts.max});
    }

    async function pubsub() {
        let opts = getOpts();
        setResults('working...');
        let nc = await nats.connect({url: opts.server});
        await nc.subscribe(opts.subject, () => {
            opts.count++;
            if (opts.count >= opts.max) {
                opts.end = Date.now();
                opts.count *= 2;
                nc.close();
                results("pubsub", opts);
            }
        }, {max: opts.max});

        nc.flush();
        opts.start = Date.now();
        for (let i = 0; i < opts.max; i++) {
            nc.publish(opts.subject);
            if (i % opts.flush === 0) {
                await nc.flush();
            }
        }
    }
</script>

</body>
</html>




