<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ws-nats chat</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
          crossorigin="anonymous">
</head>
<!-- when the browser exits, we publish a message -->
<body onunload="exiting()">

<!-- a form for entering messages -->
<div class="container">
    <h1>ws-nats chat</h1>
    <input type="text" class="form-control" id="data" placeholder="Message" autocomplete="off"><br/>
    <button id="send" onclick="send()" class="btn btn-primary">Send</button>
</div>
<br/>

<!-- a place to record messages -->
<div id="chats" class="container"></div>

<!-- load the nats library -->
<script src="../lib/nats.js"></script>

<script>
    let me = Date.now();

    // create a connection, and register listeners
    async function init() {
        let nc;
        try {
            // if the connection doesn't resolve, an exception is thrown
            // a real app would allow configuring the URL
            let conn = await nats.connect({url: "ws://localhost:8080", payload: "json"});
            nc = conn;
        } catch (ex) {
            // show the user there was an error
            let p = document.createElement("pre");
            p.appendChild(document.createTextNode(`Error connecting to NATS: ${ex}`));
            document.getElementById('chats').appendChild(p);
            return;
        }

        // handle errors sent by the gnatsd - permissions errors, etc.
        nc.addEventListener('error', (ex) => {
            let p = document.createElement("pre");
            p.appendChild(document.createTextNode(`Got error from NATS: ${ex}`));
            document.getElementById('chats').appendChild(p);
        });

        // handle connection to the server is closed
        nc.addEventListener('close', () => {
            let p = document.createElement("pre");
            p.appendChild(document.createTextNode(`NATS connection closed`));
            document.getElementById('chats').appendChild(p);
        });

        // the chat application listens for messages sent under the subject 'chat'
        nc.subscribe("chat", (msg) => {
            let p = document.createElement("pre");
            let message = msg.data.id === me ? `(me): ${msg.data.m}` : `(${msg.data.id}): ${msg.data.m}`;
            p.appendChild(document.createTextNode(message));
            document.getElementById('chats').appendChild(p);
        });

        // when a new browser joins, the joining browser publishes an 'enter' message
        nc.subscribe("enter", (msg) => {
            let p = document.createElement("pre");
            if (msg.data.id !== me) {
                p.appendChild(document.createTextNode(`${msg.data.id} entered.`));
                document.getElementById('chats').appendChild(p);
            }
        });

        // when a browser closes, the leaving browser publishes an 'exit' message
        nc.subscribe("exit", (msg) => {
            let p = document.createElement("pre");
            if (msg.data.id !== me) {
                p.appendChild(document.createTextNode(`${msg.data.id} exited.`));
                document.getElementById('chats').appendChild(p);
            }
        });

        // we connected, and we publish our enter message
        nc.publish('enter', {id: me});

        return nc;
    }

    let nc = init();

    // this is the input field
    let input = document.getElementById('data');

    // add a listener to detect edits. If they hit Enter, we publish it
    input.addEventListener("keyup", (e) => {
        if (e.key === "Enter") {
            document.getElementById("send").click();
        } else {
            e.preventDefault();
        }
    });

    // send a message if user typed one
    function send() {
        input = document.getElementById('data');
        let m = input.value;
        if (m !== "") {
            nc.publish('chat', {id: me, m: m});
            input.value = "";
        }
        return false;
    }

    //
    function exiting() {
        nc.publish('exit', {id: me});
    }
</script>
</body>
</html>




